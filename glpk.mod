/* TSP, Traveling Salesman Problem */

/* Written in GNU MathProg by Andrew Makhorin <mao@gnu.org> */

/* The Traveling Salesman Problem (TSP) is stated as follows.
   Let a directed graph G = (V, E) be given, where V = {1, ..., n} is
   a set of nodes, E <= V x V is a set of arcs. Let also each arc
   e = (i,j) be assigned a number c[i,j], which is the length of the
   arc e. The problem is to find a closed path of minimal length going
   through each node of G exactly once. */

param n, integer, >= 3;
/* number of nodes */

set V := 1..n;
/* set of nodes */

set E, within V cross V;
/* set of arcs */

param c{(i,j) in E};
/* distance from node i to node j */

var x{(i,j) in E}, binary;
/* x[i,j] = 1 means that the salesman goes from node i to node j */

minimize total: sum{(i,j) in E} c[i,j] * x[i,j];
/* the objective is to make the path length as small as possible */

s.t. leave{i in V}: sum{(i,j) in E} x[i,j] = 1;
/* the salesman leaves each node i exactly once */

s.t. enter{j in V}: sum{(i,j) in E} x[i,j] = 1;
/* the salesman enters each node j exactly once */

/* Constraints above are not sufficient to describe valid tours, so we
   need to add constraints to eliminate subtours, i.e. tours which have
   disconnected components. Although there are many known ways to do
   that, I invented yet another way. The general idea is the following.
   Let the salesman sell, say, cars, starting the travel from node 1,
   where he has n cars. If we require the salesman to sell exactly one
   car in each node, he will need to go through all nodes to satisfy
   this requirement, thus, all subtours will be eliminated. */

var y{(i,j) in E}, >= 0;
/* y[i,j] is the number of cars, which the salesman has after leaving
   node i and before entering node j; in terms of the network analysis,
   y[i,j] is a flow through arc (i,j) */

s.t. cap{(i,j) in E}: y[i,j] <= (n-1) * x[i,j];
/* if arc (i,j) does not belong to the salesman's tour, its capacity
   must be zero; it is obvious that on leaving a node, it is sufficient
   to have not more than n-1 cars */

s.t. node{i in V}:
/* node[i] is a conservation constraint for node i */

      sum{(j,i) in E} y[j,i]
      /* summary flow into node i through all ingoing arcs */

      + (if i = 1 then n)
      /* plus n cars which the salesman has at starting node */

      = /* must be equal to */

      sum{(i,j) in E} y[i,j]
      /* summary flow from node i through all outgoing arcs */

      + 1;
      /* plus one car which the salesman sells at node i */

solve;

printf "Optimal tour has length %d\n",
   sum{(i,j) in E} c[i,j] * x[i,j];
printf("From node   To node   Distance\n");
printf{(i,j) in E: x[i,j]} "      %3d       %3d   %8g\n",
   i, j, c[i,j];

data;

/* These data correspond to the symmetric instance ulysses16 from:
   Reinelt, G.: TSPLIB - A travelling salesman problem library.
   ORSA-Journal of the Computing 3 (1991) 376-84;
   http://elib.zib.de/pub/Packages/mp-testdata/tsp/tsplib */

param n := 31;

param : E : c :=
  1 2 322.198
  1 3 340.425
  1 4 220.979
  1 5 343.845
  1 6 332.657
  1 7 346.567
  1 8 155.976
  1 9 300.394
  1 10  108.554
  1 11  60.8931
  1 12  54.6144
  1 13  300.557
  1 14  223.904
  1 15  541.759
  1 16  158.552
  1 17  84.9609
  1 18  479.809
  1 19  510.215
  1 20  151.192
  1 21  517.933
  1 22  397.497
  1 23  401.834
  1 24  532.43
  1 25  385.232
  1 26  400.885
  1 27  430.571
  1 28  547.076
  1 29  516.73
  1 30  395.746
  1 31  448.321
  2 1 322.198
  2 3 23.5206
  2 4 137.707
  2 5 37.201
  2 6 70.598
  2 7 95.4835
  2 8 181.323
  2 9 126.047
  2 10  214.12
  2 11  273.668
  2 12  275.403
  2 13  158.897
  2 14  196.788
  2 15  354.202
  2 16  461.291
  2 17  338.834
  2 18  352.76
  2 19  388.693
  2 20  333.104
  2 21  480.594
  2 22  440.437
  2 23  444.192
  2 24  495.245
  2 25  446.537
  2 26  450.761
  2 27  459.547
  2 28  508.461
  2 29  493.797
  2 30  460.826
  2 31  506.335
  3 1 340.425
  3 2 23.5206
  3 4 161.08
  3 5 16.116
  3 6 57.2586
  3 7 79.8394
  3 8 202.948
  3 9 120.364
  3 10  233.037
  3 11  293.589
  3 12  294.959
  3 13  153.156
  3 14  200.723
  3 15  334.757
  3 16  481.964
  3 17  352.854
  3 18  337.796
  3 19  373.445
  3 20  342.936
  3 21  469.974
  3 22  436.561
  3 23  440.186
  3 24  484.411
  3 25  443.892
  3 26  447.169
  3 27  454.209
  3 28  497.334
  3 29  484.014
  3 30  458.144
  3 31  502.255
  4 1 220.979
  4 2 137.707
  4 3 161.08
  4 5 172.462
  4 6 188.021
  4 7 212.313
  4 8 65.1978
  4 9 205.532
  4 10  120.196
  4 11  162.426
  4 12  167.119
  4 13  229.82
  4 14  212.839
  4 15  468.028
  4 16  337.866
  4 17  267.187
  4 18  444.762
  4 19  480.779
  4 20  290.335
  4 21  545.628
  4 22  470.665
  4 23  474.947
  4 24  560.952
  4 25  469.617
  4 26  478.899
  4 27  496.895
  4 28  575.338
  4 29  553.908
  4 30  483.402
  4 31  534.733
  5 1 343.845
  5 2 37.201
  5 3 16.116
  5 4 172.462
  5 6 42.9679
  5 7 64.255
  5 8 210.765
  5 9 108.567
  5 10  237.495
  5 11  298.959
  5 12  299.909
  5 13  140.99
  5 14  193.636
  5 15  318.727
  5 16  487.985
  5 17  352.379
  5 18  321.984
  5 19  357.575
  5 20  339.224
  5 21  455.216
  5 22  424.511
  5 23  428.072
  5 24  469.58
  5 25  432.427
  5 26  435.243
  5 27  441.477
  5 28  482.409
  5 29  469.525
  5 30  446.646
  5 31  490.055
  6 1 332.657
  6 2 70.598
  6 3 57.2586
  6 4 188.021
  6 5 42.9679
  6 7 25.6546
  6 8 214.217
  6 9 67.5678
  6 10  230.734
  6 11  293.638
  6 12  293.405
  6 13  99.139
  6 14  159.771
  6 15  286.209
  6 16  482.883
  6 17  331.262
  6 18  282.208
  6 19  318.111
  6 20  310.831
  6 21  412.716
  6 22  382.294
  6 23  385.803
  6 24  427.16
  6 25  390.726
  6 26  393.122
  6 27  398.797
  6 28  440.104
  6 29  426.796
  6 30  404.905
  6 31  447.701
  7 1 346.567
  7 2 95.4835
  7 3 79.8394
  7 4 212.313
  7 5 64.255
  7 6 25.6546
  7 8 235.192
  7 9 61.2025
  7 10  247.594
  7 11  310.612
  7 12  309.848
  7 13  88.3534
  7 14  159.616
  7 15  260.559
  7 16  499.172
  7 17  339.354
  7 18  258.043
  7 19  293.783
  7 20  313.707
  7 21  391.62
  7 22  367.746
  7 23  371.097
  7 24  405.869
  7 25  377.458
  7 26  378.818
  7 27  382.642
  7 28  418.565
  7 29  406.379
  7 30  391.514
  7 31  432.633
  8 1 155.976
  8 2 181.323
  8 3 202.948
  8 4 65.1978
  8 5 210.765
  8 6 214.217
  8 7 235.192
  8 9 210.967
  8 10  57.331
  8 11  98.4959
  8 12  102.59
  8 13  227.603
  8 14  187.094
  8 15  476.353
  8 16  280.926
  8 17  204.237
  8 18  439.857
  8 19  474.929
  8 20  234.144
  8 21  523.967
  8 22  435.136
  8 23  439.529
  8 24  539.318
  8 25  431.213
  8 26  442.309
  8 27  463.714
  8 28  554.011
  8 29  529.714
  8 30  444.472
  8 31  497.062
  9 1 300.394
  9 2 126.047
  9 3 120.364
  9 4 205.532
  9 5 108.567
  9 6 67.5678
  9 7 61.2025
  9 8 210.967
  9 10  210.036
  9 11  271.84
  9 12  269.764
  9 13  32.9342
  9 14  99.196
  9 15  265.733
  9 16  456.733
  9 17  284.228
  9 18  240.286
  9 19  276.492
  9 20  254.085
  9 21  356.581
  9 22  316.207
  9 23  319.824
  9 24  371.465
  9 25  323.863
  9 26  326.847
  9 27  334.08
  9 28  385.04
  9 29  368.866
  9 30  338.086
  9 31  381.891
  10  1 108.554
  10  2 214.12
  10  3 233.037
  10  4 120.196
  10  5 237.495
  10  6 230.734
  10  7 247.594
  10  8 57.331
  10  9 210.036
  10  11  63.0216
  10  12  62.767
  10  13  218.668
  10  14  159.507
  10  15  468.603
  10  16  252.164
  10  17  147.226
  10  18  421.229
  10  19  454.937
  10  20  178.426
  10  21  490.319
  10  22  391.597
  10  23  396.031
  10  24  505.55
  10  25  385.586
  10  26  397.916
  10  27  421.673
  10  28  520.358
  10  29  494.009
  10  30  398.357
  10  31  451.471
  11  1 60.8931
  11  2 273.668
  11  3 293.589
  11  4 162.426
  11  5 298.959
  11  6 293.638
  11  7 310.612
  11  8 98.4959
  11  9 271.84
  11  10  63.0216
  11  12  8.24935
  11  13  278.309
  11  14  211.79
  11  15  526.774
  11  16  189.445
  11  17  131.36
  11  18  474.193
  11  19  506.799
  11  20  184.918
  11  21  530.615
  11  22  420.702
  11  23  425.128
  11  24  545.589
  11  25  411.438
  11  26  425.593
  11  27  452.547
  11  28  560.398
  11  29  532.058
  11  30  423.165
  11  31  476.441
  12  1 54.6144
  12  2 275.403
  12  3 294.959
  12  4 167.119
  12  5 299.909
  12  6 293.405
  12  7 309.848
  12  8 102.59
  12  9 269.764
  12  10  62.767
  12  11  8.24935
  12  13  275.304
  12  14  207.246
  12  15  523.107
  12  16  189.487
  12  17  123.177
  12  18  469.367
  12  19  501.754
  12  20  176.806
  12  21  524.04
  12  22  413.294
  12  23  417.717
  12  24  538.983
  12  25  403.844
  12  26  418.095
  12  27  445.236
  12  28  553.784
  12  29  525.27
  12  30  415.508
  12  31  468.768
  13  1 300.557
  13  2 158.897
  13  3 153.156
  13  4 229.82
  13  5 140.99
  13  6 99.139
  13  7 88.3534
  13  8 227.603
  13  9 32.9342
  13  10  218.668
  13  11  278.309
  13  12  275.304
  13  14  84.2078
  13  15  250.393
  13  16  458.621
  13  17  275.122
  13  18  215.128
  13  19  251.038
  13  20  237.729
  13  21  325.155
  13  22  283.539
  13  23  287.122
  13  24  340.142
  13  25  291.606
  13  26  294.253
  13  27  301.165
  13  28  353.882
  13  29  336.921
  13  30  305.796
  13  31  349.15
  14  1 223.904
  14  2 196.788
  14  3 200.723
  14  4 212.839
  14  5 193.636
  14  6 159.771
  14  7 159.616
  14  8 187.094
  14  9 99.196
  14  10  159.507
  14  11  211.79
  14  12  207.246
  14  13  84.2078
  14  15  318.054
  14  16  382.39
  14  17  191.318
  14  18  262.603
  14  19  295.768
  14  20  155.093
  14  21  337.005
  14  22  259.188
  14  23  263.381
  14  24  352.365
  14  25  260.321
  14  26  268.029
  14  27  284.35
  14  28  367.025
  14  29  343.394
  14  30  274.439
  14  31  324.221
  15  1 541.759
  15  2 354.202
  15  3 334.757
  15  4 468.028
  15  5 318.727
  15  6 286.209
  15  7 260.559
  15  8 476.353
  15  9 265.733
  15  10  468.603
  15  11  526.774
  15  12  523.107
  15  13  250.393
  15  14  318.054
  15  16  700.011
  15  17  498.048
  15  18  97.4797
  15  19  103.446
  15  20  440.86
  15  21  240.712
  15  22  319.576
  15  23  319.986
  15  24  248.101
  15  25  341.864
  15  26  330.427
  15  27  309.607
  15  28  253.612
  15  29  263.681
  15  30  350.692
  15  31  361.44
  16  1 158.552
  16  2 461.291
  16  3 481.964
  16  4 337.866
  16  5 487.985
  16  6 482.883
  16  7 499.172
  16  8 280.926
  16  9 456.733
  16  10  252.164
  16  11  189.445
  16  12  189.487
  16  13  458.621
  16  14  382.39
  16  15  700.011
  16  17  214.923
  16  18  635.544
  16  19  664.767
  16  20  285.28
  16  21  659.874
  16  22  529.15
  16  23  533.225
  16  24  673.653
  16  25  512.921
  16  26  530.274
  16  27  562.955
  16  28  687.922
  16  29  655.741
  16  30  521.152
  16  31  570.777
  17  1 84.9609
  17  2 338.834
  17  3 352.854
  17  4 267.187
  17  5 352.379
  17  6 331.262
  17  7 339.354
  17  8 204.237
  17  9 284.228
  17  10  147.226
  17  11  131.36
  17  12  123.177
  17  13  275.122
  17  14  191.318
  17  15  498.048
  17  16  214.923
  17  18  425.973
  17  19  453.366
  17  20  71.199
  17  21  445.504
  17  22  318.559
  17  23  322.797
  17  24  459.484
  17  25  304.59
  17  26  320.983
  17  27  352.116
  17  28  473.878
  17  29  442.227
  17  30  314.365
  17  31  366.291
  18  1 479.809
  18  2 352.76
  18  3 337.796
  18  4 444.762
  18  5 321.984
  18  6 282.208
  18  7 258.043
  18  8 439.857
  18  9 240.286
  18  10  421.229
  18  11  474.193
  18  12  469.367
  18  13  215.128
  18  14  262.603
  18  15  97.4797
  18  16  635.544
  18  17  425.973
  18  19  36.255
  18  20  363.243
  18  21  157.796
  18  22  222.097
  18  23  222.529
  18  24  168.513
  18  25  244.428
  18  26  232.97
  18  27  212.935
  18  28  177.645
  18  29  178.996
  18  30  253.216
  18  31  265.536
  19  1 510.215
  19  2 388.693
  19  3 373.445
  19  4 480.779
  19  5 357.575
  19  6 318.111
  19  7 293.783
  19  8 474.929
  19  9 276.492
  19  10  454.937
  19  11  506.799
  19  12  501.754
  19  13  251.038
  19  14  295.768
  19  15  103.446
  19  16  664.767
  19  17  453.366
  19  18  36.255
  19  20  388.699
  19  21  137.812
  19  22  225.417
  19  23  225.132
  19  24  146.209
  19  25  248.949
  19  26  235.437
  19  27  210.983
  19  28  153.202
  19  29  160.536
  19  30  256.028
  19  31  260.981
  20  1 151.192
  20  2 333.104
  20  3 342.936
  20  4 290.335
  20  5 339.224
  20  6 310.831
  20  7 313.707
  20  8 234.144
  20  9 254.085
  20  10  178.426
  20  11  184.918
  20  12  176.806
  20  13  237.729
  20  14  155.093
  20  15  440.86
  20  16  285.28
  20  17  71.199
  20  18  363.243
  20  19  388.699
  20  21  374.65
  20  22  247.671
  20  23  251.94
  20  24  388.528
  20  25  234.381
  20  26  250.425
  20  27  281.135
  20  28  402.876
  20  29  371.089
  20  30  244.647
  20  31  297.133
  21  1 517.933
  21  2 480.594
  21  3 469.974
  21  4 545.628
  21  5 455.216
  21  6 412.716
  21  7 391.62
  21  8 523.967
  21  9 356.581
  21  10  490.319
  21  11  530.615
  21  12  524.04
  21  13  325.155
  21  14  337.005
  21  15  240.712
  21  16  659.874
  21  17  445.504
  21  18  157.796
  21  19  137.812
  21  20  374.65
  21  22  142.598
  21  23  139.783
  21  24  15.3639
  21  25  165.555
  21  26  147.352
  21  27  112.859
  21  28  30.0713
  21  29  23.4177
  21  30  165.402
  21  31  146.391
  22  1 397.497
  22  2 440.437
  22  3 436.561
  22  4 470.665
  22  5 424.511
  22  6 382.294
  22  7 367.746
  22  8 435.136
  22  9 316.207
  22  10  391.597
  22  11  420.702
  22  12  413.294
  22  13  283.539
  22  14  259.188
  22  15  319.576
  22  16  529.15
  22  17  318.559
  22  18  222.097
  22  19  225.417
  22  20  247.671
  22  21  142.598
  22  23  4.44066
  22  24  153.399
  22  25  24.294
  22  26  11.7905
  22  27  33.8153
  22  28  166.004
  22  29  131.655
  22  30  31.1351
  22  31  65.9459
  23  1 401.834
  23  2 444.192
  23  3 440.186
  23  4 474.947
  23  5 428.072
  23  6 385.803
  23  7 371.097
  23  8 439.529
  23  9 319.824
  23  10  396.031
  23  11  425.128
  23  12  417.717
  23  13  287.122
  23  14  263.381
  23  15  319.986
  23  16  533.225
  23  17  322.797
  23  18  222.529
  23  19  225.132
  23  20  251.94
  23  21  139.783
  23  22  4.44066
  23  24  150.334
  23  25  26.1066
  23  26  10.4413
  23  27  29.8489
  23  28  162.782
  23  29  128.353
  23  30  30.9106
  23  31  62.1426
  24  1 532.43
  24  2 495.245
  24  3 484.411
  24  4 560.952
  24  5 469.58
  24  6 427.16
  24  7 405.869
  24  8 539.318
  24  9 371.465
  24  10  505.55
  24  11  545.589
  24  12  538.983
  24  13  340.142
  24  14  352.365
  24  15  248.101
  24  16  673.653
  24  17  459.484
  24  18  168.513
  24  19  146.209
  24  20  388.528
  24  21  15.3639
  24  22  153.399
  24  23  150.334
  24  25  175.738
  24  26  157.327
  24  27  122.369
  24  28  14.8239
  24  29  24.3639
  24  30  174.585
  24  31  151.392
  25  1 385.232
  25  2 446.537
  25  3 443.892
  25  4 469.617
  25  5 432.427
  25  6 390.726
  25  7 377.458
  25  8 431.213
  25  9 323.863
  25  10  385.586
  25  11  411.438
  25  12  403.844
  25  13  291.606
  25  14  260.321
  25  15  341.864
  25  16  512.921
  25  17  304.59
  25  18  244.428
  25  19  248.949
  25  20  234.381
  25  21  165.555
  25  22  24.294
  25  23  26.1066
  25  24  175.738
  25  26  18.545
  25  27  53.6892
  25  28  187.859
  25  29  153.302
  25  30  14.2942
  25  31  65.9199
  26  1 400.885
  26  2 450.761
  26  3 447.169
  26  4 478.899
  26  5 435.243
  26  6 393.122
  26  7 378.818
  26  8 442.309
  26  9 326.847
  26  10  397.916
  26  11  425.593
  26  12  418.095
  26  13  294.253
  26  14  268.029
  26  15  330.427
  26  16  530.274
  26  17  320.983
  26  18  232.97
  26  19  235.437
  26  20  250.425
  26  21  147.352
  26  22  11.7905
  26  23  10.4413
  26  24  157.327
  26  25  18.545
  26  27  35.1516
  26  28  169.36
  26  29  134.791
  26  30  20.6064
  26  31  56.2426
  27  1 430.571
  27  2 459.547
  27  3 454.209
  27  4 496.895
  27  5 441.477
  27  6 398.797
  27  7 382.642
  27  8 463.714
  27  9 334.08
  27  10  421.673
  27  11  452.547
  27  12  445.236
  27  13  301.165
  27  14  284.35
  27  15  309.607
  27  16  562.955
  27  17  352.116
  27  18  212.935
  27  19  210.983
  27  20  281.135
  27  21  112.859
  27  22  33.8153
  27  23  29.8489
  27  24  122.369
  27  25  53.6892
  27  26  35.1516
  27  28  134.243
  27  29  99.659
  27  30  52.565
  27  31  54.1932
  28  1 547.076
  28  2 508.461
  28  3 497.334
  28  4 575.338
  28  5 482.409
  28  6 440.104
  28  7 418.565
  28  8 554.011
  28  9 385.04
  28  10  520.358
  28  11  560.398
  28  12  553.784
  28  13  353.882
  28  14  367.025
  28  15  253.612
  28  16  687.922
  28  17  473.878
  28  18  177.645
  28  19  153.202
  28  20  402.876
  28  21  30.0713
  28  22  166.004
  28  23  162.782
  28  24  14.8239
  28  25  187.859
  28  26  169.36
  28  27  134.243
  28  29  34.6061
  28  30  185.999
  28  31  159.709
  29  1 516.73
  29  2 493.797
  29  3 484.014
  29  4 553.908
  29  5 469.525
  29  6 426.796
  29  7 406.379
  29  8 529.714
  29  9 368.866
  29  10  494.009
  29  11  532.058
  29  12  525.27
  29  13  336.921
  29  14  343.394
  29  15  263.681
  29  16  655.741
  29  17  442.227
  29  18  178.996
  29  19  160.536
  29  20  371.089
  29  21  23.4177
  29  22  131.655
  29  23  128.353
  29  24  24.3639
  29  25  153.302
  29  26  134.791
  29  27  99.659
  29  28  34.6061
  29  30  151.409
  29  31  127.028
  30  1 395.746
  30  2 460.826
  30  3 458.144
  30  4 483.402
  30  5 446.646
  30  6 404.905
  30  7 391.514
  30  8 444.472
  30  9 338.086
  30  10  398.357
  30  11  423.165
  30  12  415.508
  30  13  305.796
  30  14  274.439
  30  15  350.692
  30  16  521.152
  30  17  314.365
  30  18  253.216
  30  19  256.028
  30  20  244.647
  30  21  165.402
  30  22  31.1351
  30  23  30.9106
  30  24  174.585
  30  25  14.2942
  30  26  20.6064
  30  27  52.565
  30  28  185.999
  30  29  151.409
  30  31  53.3266
  31  1 448.321
  31  2 506.335
  31  3 502.255
  31  4 534.733
  31  5 490.055
  31  6 447.701
  31  7 432.633
  31  8 497.062
  31  9 381.891
  31  10  451.471
  31  11  476.441
  31  12  468.768
  31  13  349.15
  31  14  324.221
  31  15  361.44
  31  16  570.777
  31  17  366.291
  31  18  265.536
  31  19  260.981
  31  20  297.133
  31  21  146.391
  31  22  65.9459
  31  23  62.1426
  31  24  151.392
  31  25  65.9199
  31  26  56.2426
  31  27  54.1932
  31  28  159.709
  31  29  127.028
  31  30  53.3266
;

end;